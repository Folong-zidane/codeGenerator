package com.basiccode.generator.web;

import com.basiccode.generator.model.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

/**
 * REST Controller for perfect code generation using all 6 UML diagrams
 */
@RestController
@RequestMapping("/api/perfect")
@CrossOrigin(origins = "*")
public class PerfectGeneratorController {
    
    @Autowired
    private PerfectCodeGeneratorService perfectService;
    
    /**
     * Generate perfect code using all six diagram types
     */
    @PostMapping("/generate")
    public ResponseEntity<byte[]> generatePerfectCode(@RequestBody PerfectGenerationRequest request) {
        try {
            PerfectCodeResult result = perfectService.generatePerfectCode(request);
            
            byte[] zipBytes = createZipFromResult(result, request.language());
            
            return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, 
                    "attachment; filename=perfect-" + request.language() + "-project.zip")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(zipBytes);
                
        } catch (Exception e) {
            return ResponseEntity.internalServerError()
                .body(("Error generating perfect code: " + e.getMessage()).getBytes());
        }
    }
    
    /**
     * Validate all six diagram types
     */
    @PostMapping("/validate")
    public ResponseEntity<PerfectValidationResult> validateAllDiagrams(@RequestBody PerfectGenerationRequest request) {
        try {
            PerfectValidationResult result = new PerfectValidationResult();
            
            // Validate class diagram (required)
            if (request.classDiagramContent() == null || request.classDiagramContent().trim().isEmpty()) {
                result.addError("Class diagram content is required");
            } else if (!request.classDiagramContent().contains("classDiagram")) {
                result.addError("Invalid class diagram format");
            } else {
                result.addFeature("‚úÖ Entity structure from class diagram");
            }
            
            // Validate sequence diagram (optional)
            if (request.sequenceDiagramContent() != null && !request.sequenceDiagramContent().trim().isEmpty()) {
                if (!request.sequenceDiagramContent().contains("sequenceDiagram")) {
                    result.addError("Invalid sequence diagram format");
                } else {
                    result.addFeature("‚úÖ Behavioral logic from sequence interactions");
                }
            } else {
                result.addWarning("Sequence diagram not provided - behavioral logic will be basic");
            }
            
            // Validate state diagram (optional)
            if (request.stateDiagramContent() != null && !request.stateDiagramContent().trim().isEmpty()) {
                if (!request.stateDiagramContent().contains("stateDiagram")) {
                    result.addError("Invalid state diagram format");
                } else {
                    result.addFeature("‚úÖ State management with transitions");
                }
            } else {
                result.addWarning("State diagram not provided - no state management");
            }
            
            // Validate object diagram (optional)
            if (request.objectDiagramContent() != null && !request.objectDiagramContent().trim().isEmpty()) {
                if (!request.objectDiagramContent().contains("objectDiagram")) {
                    result.addError("Invalid object diagram format");
                } else {
                    result.addFeature("‚úÖ Test data from object instances");
                }
            } else {
                result.addWarning("Object diagram not provided - no test data generation");
            }
            
            // Validate component diagram (optional)
            if (request.componentDiagramContent() != null && !request.componentDiagramContent().trim().isEmpty()) {
                if (!request.componentDiagramContent().contains("componentDiagram")) {
                    result.addError("Invalid component diagram format");
                } else {
                    result.addFeature("‚úÖ Modular architecture from components");
                }
            } else {
                result.addWarning("Component diagram not provided - basic project structure");
            }
            
            // Validate activity diagram (optional)
            if (request.activityDiagramContent() != null && !request.activityDiagramContent().trim().isEmpty()) {
                if (!request.activityDiagramContent().contains("activityDiagram")) {
                    result.addError("Invalid activity diagram format");
                } else {
                    result.addFeature("‚úÖ Business workflows from activity diagram");
                    result.addFeature("‚úÖ Workflow engines and process automation");
                }
            } else {
                result.addWarning("Activity diagram not provided - no workflow generation");
            }
            
            // Validate language
            if (!isValidLanguage(request.language())) {
                result.addError("Unsupported language: " + request.language());
            }
            
            result.setValid(result.getErrors().isEmpty());
            
            return ResponseEntity.ok(result);
            
        } catch (Exception e) {
            PerfectValidationResult result = new PerfectValidationResult();
            result.addError("Validation error: " + e.getMessage());
            result.setValid(false);
            return ResponseEntity.ok(result);
        }
    }
    
    /**
     * Get perfect generation example with all 6 diagrams
     */
    @GetMapping("/example")
    public ResponseEntity<PerfectGenerationRequest> getPerfectExample() {
        String classExample = """
            classDiagram
                class User {
                    +UUID id
                    +String username
                    +String email
                    +UserStatus status
                    +LocalDateTime createdAt
                }
                class Order {
                    +UUID id
                    +UUID userId
                    +Float total
                    +OrderStatus status
                }
                User "1" --> "*" Order
            """;
        
        String sequenceExample = """
            sequenceDiagram
                participant Client
                participant OrderController
                participant OrderService
                participant UserService
                
                Client->>OrderController: POST /api/orders
                OrderController->>OrderService: createOrder(orderData)
                OrderService->>UserService: validateUser(userId)
                UserService-->>OrderService: user valid
                OrderService-->>OrderController: order created
                OrderController-->>Client: 201 Created
            """;
        
        String stateExample = """
            stateDiagram-v2
                [*] --> PENDING
                PENDING --> CONFIRMED : payment_success
                CONFIRMED --> PROCESSING : start_fulfillment
                PROCESSING --> SHIPPED : items_dispatched
                SHIPPED --> DELIVERED : delivery_confirmed
                DELIVERED --> [*]
            """;
        
        String objectExample = """
            objectDiagram
                object user1 {
                    id = "123e4567-e89b-12d3-a456-426614174000"
                    username = "john_doe"
                    email = "john@example.com"
                    status = "ACTIVE"
                }
                object order1 {
                    id = "456e7890-e89b-12d3-a456-426614174001"
                    userId = "123e4567-e89b-12d3-a456-426614174000"
                    total = 299.99
                    status = "PENDING"
                }
            """;
        
        String componentExample = """
            componentDiagram
                component WebLayer
                component ServiceLayer
                component DataLayer
                interface UserAPI
                interface OrderAPI
                
                WebLayer --> UserAPI
                WebLayer --> OrderAPI
                UserAPI --> ServiceLayer
                OrderAPI --> ServiceLayer
                ServiceLayer --> DataLayer
            """;
        
        String activityExample = """
            activityDiagram
                [*]
                activity ValidateUser as "Validate User"
                decision UserValid as "User Valid?"
                activity CreateOrder as "Create Order"
                activity ProcessPayment as "Process Payment"
                decision PaymentSuccess as "Payment Success?"
                activity ConfirmOrder as "Confirm Order"
                activity CancelOrder as "Cancel Order"
                end
                
                [*] --> ValidateUser
                ValidateUser --> UserValid
                UserValid --> CreateOrder : "Yes"
                UserValid --> end : "No"
                CreateOrder --> ProcessPayment
                ProcessPayment --> PaymentSuccess
                PaymentSuccess --> ConfirmOrder : "Yes"
                PaymentSuccess --> CancelOrder : "No"
                ConfirmOrder --> end
                CancelOrder --> end
            """;
        
        PerfectGenerationRequest example = new PerfectGenerationRequest(
            classExample,
            sequenceExample,
            stateExample,
            objectExample,
            componentExample,
            activityExample,
            "com.example.perfect",
            "java"
        );
        
        return ResponseEntity.ok(example);
    }
    
    /**
     * Get all supported features for perfect generation
     */
    @GetMapping("/features")
    public ResponseEntity<String[]> getAllPerfectFeatures() {
        String[] features = {
            "Complete Entity Classes with JPA",
            "Advanced State Management",
            "Realistic Business Logic", 
            "Comprehensive Test Suites",
            "Modular Architecture",
            "Business Workflow Engines",
            "Process Automation",
            "Build Configuration",
            "Spring Boot Configurations",
            "Validation Rules",
            "Exception Handling",
            "REST Controllers",
            "Service & Repository Layers",
            "Multi-module Projects",
            "Component Dependencies",
            "Workflow Orchestration",
            "Perfect Documentation"
        };
        return ResponseEntity.ok(features);
    }
    
    private byte[] createZipFromResult(PerfectCodeResult result, String language) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        
        try (ZipOutputStream zos = new ZipOutputStream(baos)) {
            // Add generated files
            for (var entry : result.getFiles().entrySet()) {
                String filename = entry.getKey();
                String content = entry.getValue();
                
                ZipEntry zipEntry = new ZipEntry(filename);
                zos.putNextEntry(zipEntry);
                zos.write(content.getBytes());
                zos.closeEntry();
            }
            
            // Add perfect README
            String readme = generatePerfectReadme(result, language);
            ZipEntry readmeEntry = new ZipEntry("README-PERFECT.md");
            zos.putNextEntry(readmeEntry);
            zos.write(readme.getBytes());
            zos.closeEntry();
            
            // Add workflow documentation
            if (!result.getWorkflows().isEmpty()) {
                StringBuilder workflowDoc = new StringBuilder("# Business Workflows\\n\\n");
                for (BusinessWorkflow workflow : result.getWorkflows()) {
                    workflowDoc.append("## ").append(workflow.getName()).append("\\n");
                    workflowDoc.append(workflow.getDescription() != null ? workflow.getDescription() : "Business workflow").append("\\n\\n");
                }
                
                ZipEntry workflowEntry = new ZipEntry("WORKFLOWS.md");
                zos.putNextEntry(workflowEntry);
                zos.write(workflowDoc.toString().getBytes());
                zos.closeEntry();
            }
        }
        
        return baos.toByteArray();
    }
    
    private String generatePerfectReadme(PerfectCodeResult result, String language) {
        StringBuilder readme = new StringBuilder();
        readme.append("# üéØ Perfect Code Generation Result\\n\\n");
        readme.append("This is the **ABSOLUTE PERFECTION** in code generation using **ALL 6 UML diagrams**:\\n\\n");
        
        readme.append("## üìä Complete UML Integration\\n\\n");
        readme.append("1. **üìã Class Diagram** ‚Üí Entity structure and relationships\\n");
        readme.append("2. **üîÑ Sequence Diagram** ‚Üí Behavioral interactions and business logic\\n");
        readme.append("3. **‚ö° State Diagram** ‚Üí State management and transitions\\n");
        readme.append("4. **üéØ Object Diagram** ‚Üí Test data and validation\\n");
        readme.append("5. **üèóÔ∏è Component Diagram** ‚Üí Architecture and modular structure\\n");
        readme.append("6. **üîÄ Activity Diagram** ‚Üí Workflows and business processes\\n\\n");
        
        readme.append("## üéâ Perfect Features Generated\\n\\n");
        readme.append("‚úÖ **Complete Entity Classes** with all JPA annotations and audit fields\\n");
        readme.append("‚úÖ **Advanced State Management** with enums and transition validation\\n");
        readme.append("‚úÖ **Realistic Business Logic** extracted from sequence interactions\\n");
        readme.append("‚úÖ **Comprehensive Test Suites** with real test data from objects\\n");
        readme.append("‚úÖ **Modular Architecture** based on component dependencies\\n");
        readme.append("‚úÖ **Business Workflow Engines** from activity diagrams\\n");
        readme.append("‚úÖ **Process Automation** with workflow orchestration\\n");
        readme.append("‚úÖ **Perfect Build Configuration** (Maven/Gradle)\\n");
        readme.append("‚úÖ **Spring Boot Configurations** for each component\\n");
        readme.append("‚úÖ **REST Controllers** with state-aware endpoints\\n");
        readme.append("‚úÖ **Service Layer** with complete business methods and workflows\\n");
        readme.append("‚úÖ **Repository Layer** with CRUD operations\\n");
        readme.append("‚úÖ **Exception Handling** based on all interaction patterns\\n");
        readme.append("‚úÖ **Validation Rules** preventing invalid operations\\n");
        readme.append("‚úÖ **Perfect Documentation** for all components and processes\\n\\n");
        
        readme.append("## üìÅ Perfect Project Structure\\n\\n");
        readme.append("```\\n");
        for (String filename : result.getFiles().keySet()) {
            readme.append("‚îú‚îÄ‚îÄ ").append(filename).append("\\n");
        }
        readme.append("```\\n\\n");
        
        readme.append("## üöÄ How to Run\\n\\n");
        switch (language.toLowerCase()) {
            case "java" -> {
                readme.append("```bash\\n");
                readme.append("# Build the perfect project\\n");
                readme.append("mvn clean install\\n\\n");
                readme.append("# Run the perfect application\\n");
                readme.append("mvn spring-boot:run\\n");
                readme.append("```\\n");
            }
            case "python", "django" -> {
                readme.append("```bash\\n");
                readme.append("# Install perfect dependencies\\n");
                readme.append("pip install -r requirements.txt\\n\\n");
                readme.append("# Run the perfect application\\n");
                readme.append("python main.py\\n");
                readme.append("```\\n");
            }
        }
        
        readme.append("\\n## üéØ Perfect API Endpoints\\n\\n");
        readme.append("The generated application includes perfectly crafted RESTful endpoints\\n");
        readme.append("with complete state management, workflow orchestration, and validation.\\n\\n");
        
        readme.append("## üîç Perfect Testing\\n\\n");
        readme.append("```bash\\n");
        readme.append("# Run all perfect tests\\n");
        readme.append("mvn test\\n");
        readme.append("```\\n\\n");
        
        readme.append("## üîÄ Business Workflows\\n\\n");
        readme.append("The application includes complete workflow engines that automate\\n");
        readme.append("business processes extracted from your activity diagrams.\\n\\n");
        
        readme.append("---\\n");
        readme.append("**Generated with PERFECT UML integration - the absolute pinnacle of code generation!** üéØ");
        
        return readme.toString();
    }
    
    private boolean isValidLanguage(String language) {
        return language != null && 
               (language.equals("java") || language.equals("python") || 
                language.equals("django") || language.equals("csharp") || 
                language.equals("typescript") || language.equals("php"));
    }
    
    /**
     * Validation result for perfect generation
     */
    public static class PerfectValidationResult {
        private boolean valid = true;
        private java.util.List<String> errors = new java.util.ArrayList<>();
        private java.util.List<String> warnings = new java.util.ArrayList<>();
        private java.util.List<String> features = new java.util.ArrayList<>();
        
        public boolean isValid() { return valid; }
        public void setValid(boolean valid) { this.valid = valid; }
        
        public java.util.List<String> getErrors() { return errors; }
        public void addError(String error) { this.errors.add(error); }
        
        public java.util.List<String> getWarnings() { return warnings; }
        public void addWarning(String warning) { this.warnings.add(warning); }
        
        public java.util.List<String> getFeatures() { return features; }
        public void addFeature(String feature) { this.features.add(feature); }
    }
}