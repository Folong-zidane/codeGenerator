sequenceDiagram
    participant Client
    participant UserController
    participant UserService
    participant UserRepository
    participant Database

    %% User Registration Flow
    Client->>+UserController: POST /api/users/register
    Note over Client,UserController: User registration request
    
    UserController->>+UserService: createUser(userData)
    Note over UserService: Validate user data
    
    alt Valid user data
        UserService->>+UserRepository: save(user)
        UserRepository->>+Database: INSERT INTO users
        Database-->>-UserRepository: User created
        UserRepository-->>-UserService: User entity
        UserService-->>-UserController: Created user
        UserController-->>-Client: 201 Created
    else Invalid data
        UserService-->>UserController: ValidationException
        UserController-->>Client: 400 Bad Request
    end

    %% User Login Flow
    Client->>+UserController: POST /api/users/login
    UserController->>+UserService: authenticateUser(credentials)
    
    UserService->>+UserRepository: findByEmail(email)
    UserRepository->>+Database: SELECT * FROM users WHERE email = ?
    Database-->>-UserRepository: User data
    UserRepository-->>-UserService: User entity
    
    opt User found
        UserService->>UserService: validatePassword(password)
        alt Password valid
            UserService->>UserService: generateToken()
            UserService-->>UserController: AuthToken
            UserController-->>Client: 200 OK with token
        else Password invalid
            UserService-->>UserController: AuthenticationException
            UserController-->>Client: 401 Unauthorized
        end
    end

    %% Get User Profile
    Client->>+UserController: GET /api/users/profile
    Note over Client,UserController: With Authorization header
    
    UserController->>UserController: validateToken()
    UserController->>+UserService: getUserProfile(userId)
    UserService->>+UserRepository: findById(userId)
    UserRepository->>+Database: SELECT * FROM users WHERE id = ?
    Database-->>-UserRepository: User data
    UserRepository-->>-UserService: User entity
    UserService-->>-UserController: User profile
    UserController-->>-Client: 200 OK with profile

    %% Update User Profile
    Client->>+UserController: PUT /api/users/profile
    UserController->>+UserService: updateUserProfile(userId, profileData)
    
    loop Validate each field
        UserService->>UserService: validateField(field, value)
    end
    
    UserService->>+UserRepository: update(user)
    UserRepository->>+Database: UPDATE users SET ... WHERE id = ?
    Database-->>-UserRepository: Updated rows
    UserRepository-->>-UserService: Updated user
    UserService-->>-UserController: Updated profile
    UserController-->>-Client: 200 OK

    %% Delete User Account
    Client->>+UserController: DELETE /api/users/account
    UserController->>+UserService: deleteUserAccount(userId)
    
    critical Ensure data consistency
        UserService->>+UserRepository: softDelete(userId)
        UserRepository->>+Database: UPDATE users SET deleted_at = NOW()
        Database-->>-UserRepository: Success
        UserRepository-->>-UserService: Deleted user
    option Database error
        UserService->>UserService: rollbackTransaction()
        UserService-->>UserController: DatabaseException
        UserController-->>Client: 500 Internal Server Error
    end
    
    UserService-->>-UserController: Account deleted
    UserController-->>-Client: 204 No Content